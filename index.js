import TelegramBot from "node-telegram-bot-api";
import dotenv from "dotenv";
dotenv.config();

const bot = new TelegramBot(process.env.BOT_TOKEN, { polling: true });

// –ö–æ–º–∞–Ω–¥–∞ /start
bot.onText(/\/start/, (msg) => {
    bot.sendMessage(msg.chat.id,
        "‚ú® –†–∞–¥—ñ –≤—ñ—Ç–∞—Ç–∏ —Ç–µ–±–µ, —Å–≤—ñ—Ç–ª–∞ –¥—É—à–∞, —É –ø—Ä–æ—Å—Ç–æ—Ä—ñ —Ç–∏—à—ñ Vipassana.Yoga üôè\n\n" +
        "–í–∂–µ –∑–æ–≤—Å—ñ–º —Å–∫–æ—Ä–æ –≤—ñ–¥–±—É–¥–µ—Ç—å—Å—è –±–ª–∞–≥–æ–¥—ñ–π–Ω–∏–π —Ä–µ—Ç—Ä–∏—Ç 8‚Äì12 –∂–æ–≤—Ç–Ω—è 2025 —Ä–æ–∫—É.\n" +
        "–¶–µ —á–∞—Å –≥–ª–∏–±–æ–∫–æ—ó –ø—Ä–∞–∫—Ç–∏–∫–∏ —Ç–∞ –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è.\n\n" +
        "–†–µ—Ç—Ä–∏—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç–∏–º–µ —É –¥–≤–æ—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö:\n" +
        "‚õ∞Ô∏è –û—Ñ–ª–∞–π–Ω ‚Äî —É –∂–∏–≤—ñ–π –ø—Ä–∏—Å—É—Ç–Ω–æ—Å—Ç—ñ –≤ –∫–æ–ª—ñ –æ–¥–Ω–æ–¥—É–º—Ü—ñ–≤ —É –ö–∞—Ä–ø–∞—Ç–∞—Ö\n" +
        "üíª –û–Ω–ª–∞–π–Ω ‚Äî –∑ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—é –ø—Ä–∞–∫—Ç–∏–∫—É–≤–∞—Ç–∏ –∑ –±—É–¥—å-—è–∫–æ—ó —Ç–æ—á–∫–∏ —Å–≤—ñ—Ç—É\n\n" +
        "–©–æ–± –¥—ñ–∑–Ω–∞—Ç–∏—Å—è –±—ñ–ª—å—à–µ, –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è —á–∏ –ø—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ—î–∫—Ç ‚Äî –æ–±–µ—Ä–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∏–π –ø—É–Ω–∫—Ç –Ω–∏–∂—á–µ üëá"
    );

    bot.sendMessage(msg.chat.id,
        "1Ô∏è‚É£ –†–ï–¢–†–ò–¢ –ö–ê–†–ü–ê–¢–ò \n—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —è–∫ —É—á–∞—Å–Ω–∏–∫–∞ üßò‚Äç‚ôÄÔ∏è\n\n" +
        "2Ô∏è‚É£ –°–õ–£–ñ–Ü–ù–ù–Ø –ù–ê –†–ï–¢–†–ò–¢–Ü\n–¥–µ—Ç–∞–ª—ñ —ñ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è üôèüèª\n\n" +
        "3Ô∏è‚É£ –û–ù–õ–ê–ô–ù –†–ï–¢–†–ò–¢ \n–¥–µ—Ç–∞–ª—ñ —ñ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è üë®‚Äçüíª\n\n" +
        "4Ô∏è‚É£ –î–û–ù–ê–¢ \n–±–ª–∞–≥–æ–¥—ñ–π–Ω–∏–π –≤–Ω–µ—Å–æ–∫ –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ —Ä–µ—Ç—Ä–∏—Ç—É ü´∂üèª\n\n" +
        "5Ô∏è‚É£ –ü–ò–¢–ê–ù–ù–Ø \n–í–∏ –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥—ñ ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —ñ –º–∏ –≤–∞–º –≤—ñ–¥–ø–æ–≤—ñ–º–æ ‚òÄÔ∏è",
        {
            reply_markup: {
                inline_keyboard: [
                    [
                        { text: "1Ô∏è‚É£", callback_data: "option_1" },
                        { text: "2Ô∏è‚É£", callback_data: "option_2" }
                    ],
                    [
                        { text: "3Ô∏è‚É£", callback_data: "option_3" },
                        { text: "4Ô∏è‚É£", callback_data: "option_4" }
                    ]
                ]
            }
        }
    );

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏
    bot.on('callback_query', (query) => {
        const chatId = query.message.chat.id;
        let responseText = "";

        switch (query.data) {
            case "option_1":
                responseText = "–í–∏ –æ–±—Ä–∞–ª–∏ –†–ï–¢–†–ò–¢ –ö–ê–†–ü–ê–¢–ò üßò‚Äç‚ôÄÔ∏è\n\n–ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è —Ä–µ—Ç—Ä–∏—Ç—É –∑–∞ –∫–æ–º–∞–Ω–¥–æ—é /rules\n–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —è–∫ —É—á–∞—Å–Ω–∏–∫–∞: [–ø–æ—Å–∏–ª–∞–Ω–Ω—è –∞–±–æ –¥–µ—Ç–∞–ª—ñ —Ç—É—Ç]";
                break;
            case "option_2":
                responseText = "–í–∏ –æ–±—Ä–∞–ª–∏ –°–õ–£–ñ–Ü–ù–ù–Ø –ù–ê –†–ï–¢–†–ò–¢–Ü üôèüèª\n\n–ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è —Ä–µ—Ç—Ä–∏—Ç—É –∑–∞ –∫–æ–º–∞–Ω–¥–æ—é /rules\n–î–µ—Ç–∞–ª—ñ —ñ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è: [–ø–æ—Å–∏–ª–∞–Ω–Ω—è –∞–±–æ –¥–µ—Ç–∞–ª—ñ —Ç—É—Ç]";
                break;
            case "option_3":
                responseText = "–í–∏ –æ–±—Ä–∞–ª–∏ –û–ù–õ–ê–ô–ù –†–ï–¢–†–ò–¢ üë®‚Äçüíª\n\n–ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è —Ä–µ—Ç—Ä–∏—Ç—É –∑–∞ –∫–æ–º–∞–Ω–¥–æ—é /rules\n–î–µ—Ç–∞–ª—ñ —ñ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è: [–ø–æ—Å–∏–ª–∞–Ω–Ω—è –∞–±–æ –¥–µ—Ç–∞–ª—ñ —Ç—É—Ç]";
                break;
            case "option_4":
                responseText = "–í–∏ –æ–±—Ä–∞–ª–∏ –î–û–ù–ê–¢ ü´∂üèª\n–ë–ª–∞–≥–æ–¥—ñ–π–Ω–∏–π –≤–Ω–µ—Å–æ–∫ –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ —Ä–µ—Ç—Ä–∏—Ç—É: [–ø–æ—Å–∏–ª–∞–Ω–Ω—è –∞–±–æ –¥–µ—Ç–∞–ª—ñ —Ç—É—Ç]";
                break;
            default:
                responseText = "–ù–µ–≤—ñ–¥–æ–º–∞ –æ–ø—Ü—ñ—è.";
        }

        bot.answerCallbackQuery(query.id)
            .then(() => {
                bot.sendMessage(chatId, responseText);
            });
    });
    console.log(msg.chat);
});

// –†–∞—Å—Å—ã–ª–∫–∞ —É—Å–ª–æ–≤–∏–π
bot.onText(/\/rules/, (msg) => {
    bot.sendMessage(msg.chat.id,
        "‚ú® –£–º–æ–≤–∏ —Ä–µ—Ç—Ä–∏—Ç—É:\n" +
        "- –•–∞—Ä—á—É–≤–∞–Ω–Ω—è –≤–µ–≥–µ—Ç–∞—Ä—ñ–∞–Ω—Å—å–∫–∞ \n" +
        "- –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –≥–∞–¥–∂–µ—Ç–∏\n" +
        "- –†–æ–∑–ø–æ—Ä—è–¥–æ–∫ –¥–Ω—è –∑–∞ –∫–æ–º–∞–Ω–¥–æ—é /schedule"
    );
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Å—ã–ª–∫–∏ –≤—Ä—É—á–Ω—É—é
bot.onText(/\/link/, (msg) => {
    bot.sendMessage(msg.chat.id, "–û—Å—å –∫–æ—Ä–∏—Å–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è: https://example.com");
});

// –õ—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ = –≤–æ–ø—Ä–æ—Å ‚Üí –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç + –ø–µ—Ä–µ—Å—ã–ª–∫–∞ –≤ —á–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏
bot.on("message", (msg) => {
    const chatId = msg.chat.id;

    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã
    if (msg.text && msg.text.startsWith("/")) return;

    // –ï—Å–ª–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ ‚Äî –≤—ã—Ö–æ–¥–∏–º
    if (chatId.toString() === process.env.SUPPORT_CHAT_ID) return;

    // –ê–≤—Ç–æ–æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    bot.sendMessage(chatId,
        "–î—è–∫—É—î–º–æ –∑–∞ –ø–∏—Ç–∞–Ω–Ω—è, —Å–≤—ñ—Ç–ª–∞ –¥—É—à–∞ üôè\n" +
        "–°–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –∑–≤ º—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ —É —Ä–æ–±–æ—á–∏–π —á–∞—Å (8:00‚Äì20:00) " +
        "—á–∏ —è–∫ —Ç—ñ–ª—å–∫–∏ –∑ º—è–≤–∏—Ç—å—Å—è –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å."
    );


    // –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º –≤ —á–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏
    if (process.env.SUPPORT_CHAT_ID) {
    bot.forwardMessage(process.env.SUPPORT_CHAT_ID, chatId, msg.message_id)
      .then((sentMessage) => {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ: message_id –ø–µ—Ä–µ—Å–ª–∞–Ω–Ω–æ–≥–æ ‚Üí chat.id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        replyMap.set(sentMessage.message_id, chatId);
      });
  }
});

bot.on("message", (msg) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º: —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏?
    if (msg.chat.id.toString() !== process.env.SUPPORT_CHAT_ID) return;
    if (!msg.reply_to_message) return;

    // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –∞–≤—Ç–æ—Ä–∞ –≤–æ–ø—Ä–æ—Å–∞
    const fwd = msg.reply_to_message.forward_from
        || msg.reply_to_message.forward_origin?.sender_user;

    if (!fwd) {
        bot.sendMessage(msg.chat.id, "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–≤–µ—Ç–∞.");
        return;
    }

    const userId = fwd.id;

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    bot.sendMessage(userId, "üì© –í—ñ–¥–ø–æ–≤—ñ–¥—å –ø—ñ–¥—Ç—Ä–∏–º–∫–∏:\n" + msg.text)
        .then(() => {
            bot.sendMessage(msg.chat.id, "‚úÖ –í—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞–¥—ñ—Å–ª–∞–Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É.");
        })
        .catch(err => {
            bot.sendMessage(msg.chat.id, "‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É.");
            console.error(err);
        });
});